<!doctype html>
<html>
<head>
    <link rel="stylesheet" href="/css/uPlot.min.css">
    <script src="/js/uPlot.iife.min.js"></script>
    <script>
        let opts = {
            title: "My Chart",
            id: "chart1",
            class: "my-chart",
            width: 800,
            height: 600,
            series: [
                // {},
                // {
                //     show: true,
                //     spanGaps: false,
                //     label: "RAM",
                //     value: (self, rawValue) => rawValue.toFixed(2),
                //     stroke: "red",
                //     width: 1,
                //     fill: "rgba(255, 0, 0, 0.3)",
                //     dash: [10, 5],
                // }
            ],
            axes: [
                // {},
            //     {
            //         scale: "%",
            //         values: (u, vals, space) => vals.map(v => +v.toFixed(1) + "%"),
            //     },
            //     {
            //         side: 1,
            //         scale: "mb",
            //         size: 60,
            //         values: (u, vals, space) => vals.map(v => +v.toFixed(2) + " MB"),
            //         grid: {show: false},
            //     },
            ],
        };

        window.onload = function() {
            time_series = [];
            fetch('/logs/manifest.json')
            .then(response => response.text())
            .then((data) => {
                manifest = JSON.parse(data);
                // for (var key in manifest) {
                //     value = manifest[key];
                //     console.log(value);
                // }
                value = manifest[Object.keys(manifest)[0]];

                fetch('/logs/' + value['data'])
                .then(response => response.text())
                .then((data) => {
                    // parse rudimentary csv
                    lines = data.split('\n');
                    lines.forEach(line => {
                        cells = line.split(',');
                        if (cells.length <= 1) {
                            return;
                        }
                        for (i = 0; i < cells.length-1; i++) {
                            if (time_series[i] == null) {
                                time_series[i] = [];
                            }
                            if (i == 0) {
                                timestamp = cells[i];
                                year = parseInt(timestamp.substring(0, 4));
                                month = parseInt(timestamp.substring(5,7));
                                day = parseInt(timestamp.substring(8, 10));
                                hour = parseInt(timestamp.substring(11, 13));
                                minute = parseInt(timestamp.substring(13, 15));
                                second = parseInt(timestamp.substring(15, 18));
                                date = new Date(year, month, day, hour, minute, second);
                                unixtime = date.getTime() / 1000;  // milliseconds to seconds
                                // note time zone is not correct here, expects UTC time but is provided local time.
                                time_series[i].push(unixtime);
                            } else {
                                time_series[i].push(parseInt(cells[i]));
                            }
                        }
                    });

                    for (i = 0; i < time_series.length; i++) {
                        opts.series.push({
                            show: true,
                        // spanGaps: false,
                //     label: "RAM",
                //     value: (self, rawValue) => rawValue.toFixed(2),
                    stroke: "red",
                    width: 1,
                    fill: "rgba(255, 0, 0, 0.3)",
                //     dash: [10, 5],
                        });
                    }

                    let uplot = new uPlot(opts, time_series, document.body);
                });
            });
        }
    </script>
</head>
<body>
</body>
</html>